# Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## dnb_results

To explore this data set we have decided to start on a national level to analyse the global tendency. We will then go down a level to a regional analysis to compare the number of students and see which region performs better. An analysis at the regional level will then be performed to dig deeper into the success rate and the graduation rate for each mention. To be complete with our analysis, we will see the results by establishment for the best and worst performing establishments in 2020. We will use their results of 2006 in comparison.

### National analysis

```{r, echo=TRUE}
France_results <- dnb_results %>% #select(session,registered, present, contains("admitted")) %>% 
  group_by(session) %>% 
  summarise(registered = sum(registered),
            present = sum(present),
            admitted = sum(admitted),
            admitted_without = sum(admitted_without),
            admitted_AB = sum(admitted_AB),
            admitted_B = sum(admitted_B),
            admitted_TB = sum(admitted_TB),
            without_pct = mean(without_pct, na.rm = TRUE),
            AB_pct = mean(AB_pct, na.rm = TRUE),
            B_pct = mean(B_pct, na.rm = TRUE),
            TB_pct = mean(TB_pct, na.rm = TRUE),
            success_rate_pct = mean(success_rate_pct, na.rm = TRUE)) %>% 
  pivot_longer(c(registered, present,contains("admitted")),
               names_to = "Candidates",
               values_to = "Number_of_students") %>% 
   pivot_longer(c(contains("pct")), 
               names_to = "Mention_type",
               values_to = "Rate")



```

The graph below was made by first grouping data by `session`. A `sum` was then applied to summarize the variables.
```{r, echo = TRUE, warning = FALSE, out.width='100%', out.height= '50%'}

p <- France_results %>% 
  ggplot(aes(x = session, y = Number_of_students, group = Candidates, color = Candidates))+
  geom_line()+
  scale_color_viridis(discrete = TRUE) +
    ggtitle("National DNB statistics") +
    theme_ipsum() +
    ylab("Number of students")

ggplotly(p, tooltip = c("x" ,"y"))

```

We can notice that the 



National DNB statistics (rate)

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- France_results %>% 
  ggplot(aes(x = session, y = Rate, group = Mention_type, color = Mention_type))+
  geom_line()+
  scale_color_viridis(discrete = TRUE) +
    ggtitle("National DNB statistics") +
    theme_ipsum() +
    ylab("Rate in %")

ggplotly(p, tooltip = c("x" ,"y"))

```

### Regional Analysis

Success rate

```{r, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
  select(success_rate_pct, region, department) %>% 
  group_by(region) %>% 
  summarise(success_rate = mean(success_rate_pct, na.rm = TRUE)) %>% 
  ggplot(aes(x = region, 
             y = success_rate, 
             fill = region)) + 
         geom_col() +
         scale_fill_viridis(discrete = TRUE) +
         theme_ipsum() +
         ggtitle("Success rate") +
         ylab("Rate in %")+
         theme(axis.title.x=element_blank(),
               axis.text.x=element_blank(),
               axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```



#### Number of students per result and region during the period 2006-2021 {.tabset}
##### Number of admitted by region

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted, region) %>% 
 group_by(region) %>% 
 summarise(admitted = sum(admitted)) %>% 
 ggplot(aes(x = region,
            y = admitted, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Number of admitted by region") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

##### Admitted with zero mention

```{r, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_without, region) %>% 
 group_by(region) %>% 
 summarise(zero = sum(admitted_without)) %>% 
 ggplot(aes(x = region, 
            y = zero, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with zero mention") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```


##### Admitted with mention AB

```{r, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_AB, region) %>% 
 group_by(region) %>% 
 summarise(AB = sum(admitted_AB)) %>% 
 ggplot(aes(x = region, 
            y = AB, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention AB") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```


##### Admitted with mention B

```{r, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_B, region) %>% 
 group_by(region) %>% 
 summarise(B = sum(admitted_B)) %>% 
 ggplot(aes(x = region, 
            y = B, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention B") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```


##### Admitted with mention TB

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_TB, region) %>% 
 group_by(region) %>% 
 summarise(TB = sum(admitted_TB)) %>% 
 ggplot(aes(x = region, 
            y = TB, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention TB") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

####{-}

#### Period 2006-2021 by region {.tabset}
##### Success rate 

```{r}
y_scale_pct <- scale_y_continuous(limits = range(c(0:100)))

```


```{r, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(success_rate_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(success_rate = mean(success_rate_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = success_rate, 
            color = region,
            text = region)) + 
        geom_line() +
        y_scale_pct +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Success rate") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with zero mention

```{r, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(without_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(zero = mean(without_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = zero, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with zero mention") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention AB
```{r, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(AB_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(AB = mean(AB_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = AB, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention AB") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention B
```{r, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(B_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(B = mean(B_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = B, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention B") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention TB
```{r, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(TB_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(TB = mean(TB_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = TB, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention TB") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

####{-}

### Departmental Analysis
#### Box plot Analysis per department {.tabset}

```{r}

dnb_pct_dep <- dnb_results %>%
  group_by(department, session) %>% 
  summarise(AB_pct_dep = mean(AB_pct, na.rm = TRUE),
            B_pct_dep = mean(B_pct, na.rm = TRUE),
            TB_pct_dep = mean(TB_pct, na.rm = TRUE),
            without_pct_dep = mean(without_pct, na.rm = TRUE),
            success_rate_pct_dep = mean(success_rate_pct, na.rm = TRUE))
datatable(dnb_pct_dep)
```

##### success_rate_pct

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = success_rate_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = success_rate_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", y = "Success rate in %",
                title ="Success rate of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### without_pct

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = without_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = without_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with no mention in %",
              title ="Rate of students with no mention of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
        
```

##### B_pct

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = B_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = B_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Bien in %",
              title ="Rate of students with mention Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### AB_pct

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = AB_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = AB_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Assez Bien in %",
              title ="Rate of students with mention Assez Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### TB_pct

```{r, warning = FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = TB_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = TB_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Très Bien in %",
              title ="Rate of students with mention Très Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))

```

####  {.unnumbered}

#### Box plot Analysis of at the Department level {.tabset}

##### Paris 2020
First analysis of the best performing highest rate of TB -> Paris 2020

```{r, out.width='100%', out.height= '50%'}

Paris <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  filter(department == "PARIS", session == "2020") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Paris$Mention_type <- factor(Paris$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

p <- Paris %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Parisian establishments in 2020")

ggplotly(p, tooltip = c("text","text2"))


```


##### Paris 2006
First analysis of the best performing highest rate of TB -> Paris 2020

```{r, out.width='100%', out.height= '50%'}

Paris <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  filter(department == "PARIS", session == "2006") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Paris$Mention_type <- factor(Paris$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

p <- Paris %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Parisian establishments in 2006")

ggplotly(p, tooltip = c("text","text2"))


```


##### Eure et Loir 2020 
Lowest performing department in TB rate and "best" in zero mention rate -> Guyane 2006
```{r, out.width='100%', out.height= '50%'}

Eure <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  dplyr::filter(department == "EURE-ET-LOIR", session == "2020") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Eure$Mention_type <- factor(Eure$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

 p <- Eure %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Eure et Loir establishments in 2020")

ggplotly(p, tooltip = c("text","text2"))
```

##### Eure et Loir 2006 
Lowest performing department in TB rate and "best" in zero mention rate -> Guyane 2006
```{r, out.width='100%', out.height= '50%'}

Eure <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  dplyr::filter(department == "EURE-ET-LOIR", session == "2006") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Eure$Mention_type <- factor(Eure$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

 p <- Eure %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Eure et Loir establishments in 2006")

ggplotly(p, tooltip = c("text","text2"))
```

####  {.unnumbered}

## Establishment_24
The 
```{r, warning=FALSE, out.width='100%', out.height= '50%'}
g <- list(
  scope = 'europe',
  showland = TRUE,
  landcolor = toRGB("grey83"),
  subunitcolor = toRGB("white"),
  countrycolor = toRGB("white"),
  showlakes = TRUE,
  lakecolor = toRGB("white"),
  showsubunits = TRUE,
  showcountries = TRUE,
  resolution = 50
)
fig <- plot_geo(establishment_24, lat = ~latitude, lon = ~longitude)
fig <- fig %>% 
  layout(title = 'Establishment labellised Generation 2024', geo = g) %>% 
  add_markers(text = ~paste(department, establishment, sep = "<br />"),
              hoverinfo = "text")
fig
```


### esssai carte

Creation of the map theme

```{r, echo = TRUE}

map_theme <- theme(title=element_text(),
                   plot.title=element_text(margin=margin(20,20,20,20), size=18, hjust = 0.5),
                   axis.text.x=element_blank(),
                   axis.text.y=element_blank(),
                   axis.ticks=element_blank(),
                   axis.title.x=element_blank(),
                   axis.title.y=element_blank(),
                   panel.grid.major= element_blank(), 
                   panel.background= element_blank()) 
```

Creation of the dataset used for the map

```{r, echo = TRUE}

result <- dnb_results %>% 
  select(department_fr, success_rate_pct) %>% 
  group_by(department_fr) %>% 
  summarise(success_rate = mean(success_rate_pct))

```

Join the map from ggplot and our new dataset

```{r, echo = TRUE}

result_map <- left_join(x = map[,-6], y = result)
```

plot

```{r, warning=FALSE, out.width='75%', out.height= '75%'}

p <-  ggplot() +
  geom_polygon(data = result_map, aes(long,lat, 
                            group = group, 
                            fill = success_rate, 
                            text = department_fr)) +
  geom_point(data = establishment_24, aes(x = longitude , y = latitude, text2= establishment), size = 0.5)+
  coord_map() +
  scale_fill_viridis(name = "Average sucess rate")+
  labs(x = "", 
       y = "", 
       title = "Average success rate, 2006-2021") +
  map_theme
  
ggplotly(p, tooltip = c("text2") )


#for other examples to change colours https://colinfay.me/mapping-the-french-second-round-results-with-r/
```

-   Mapping out the underlying structure
-   Identifying the most important variables
-   Univariate visualizations
-   Multivariate visualizations
-   Summary tables

