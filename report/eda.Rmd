# Exploratory data analysis

```{r, echo = FALSE, message = FALSE}
source(here::here("scripts/setup.R"))
```

## dnb_results

To explore this data set we have decided to start on a national level to analyse the global tendency. We will then go down a level to a regional analysis to compare the number of students and see which region performs better. An analysis at the regional level will then be performed to dig deeper into the success rate and the graduation rate for each mention. To be complete with our analysis, we will see the results by establishment for the best and worst performing establishments in 2020. We will use their results of 2006 in comparison.

### National analysis

**Talk about the two graph (e.g. number of students growing, what is the number of students, pct growth, ... ). Mention that the shift at year 2017 will be analysed in the analysis.**

```{r, echo=TRUE}
France_results <- dnb_results %>% 
  #select(session,registered, present, contains("admitted")) %>% 
  group_by(session) %>% 
  summarise(registered = sum(registered),
            present = sum(present),
            admitted = sum(admitted),
            admitted_without = sum(admitted_without),
            admitted_AB = sum(admitted_AB),
            admitted_B = sum(admitted_B),
            admitted_TB = sum(admitted_TB),
            without_pct = mean(without_pct, na.rm = TRUE),
            AB_pct = mean(AB_pct, na.rm = TRUE),
            B_pct = mean(B_pct, na.rm = TRUE),
            TB_pct = mean(TB_pct, na.rm = TRUE),
            success_rate_pct = mean(success_rate_pct, na.rm = TRUE)) %>% 
  pivot_longer(c(registered, present,contains("admitted")),
               names_to = "Candidates",
               values_to = "Number_of_students") %>% 
   pivot_longer(c(contains("pct")), 
               names_to = "Mention_type",
               values_to = "Rate")



```

The graph below was made by first grouping data by `session`. A `sum` was then applied to summarize the variables.

```{r, echo = TRUE, warning = FALSE, out.width='100%', out.height= '50%'}

p <- France_results %>% 
  ggplot(aes(x = session, y = Number_of_students, group = Candidates, color = Candidates))+
  geom_line()+
  scale_color_viridis(discrete = TRUE) +
    ggtitle("National DNB statistics") +
    theme_ipsum() +
    ylab("Number of students")

ggplotly(p, tooltip = c("x" ,"y"))

```

We can notice that the

National DNB statistics (rate)

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- France_results %>% 
  ggplot(aes(x = session, y = Rate, group = Mention_type, color = Mention_type))+
  geom_line()+
  scale_color_viridis(discrete = TRUE) +
    ggtitle("National DNB statistics") +
    theme_ipsum() +
    ylab("Rate in %")

ggplotly(p, tooltip = c("x" ,"y"))

```

### Regional Analysis

Success rate

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
  select(success_rate_pct, region, department) %>% 
  group_by(region) %>% 
  summarise(success_rate = mean(success_rate_pct, na.rm = TRUE)) %>% 
  ggplot(aes(x = region, 
             y = success_rate, 
             fill = region)) + 
         geom_col() +
         scale_fill_viridis(discrete = TRUE) +
         theme_ipsum() +
         ggtitle("Success rate") +
         ylab("Rate in %")+
         theme(axis.title.x=element_blank(),
               axis.text.x=element_blank(),
               axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

#### Number of students per result and region during the period 2006-2021 {.tabset}

**One description for all of what we see and highlight differences (e.g. Bretagne has higher proportion of students with mentions than no mention).**

##### Number of admitted by region

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted, region) %>% 
 group_by(region) %>% 
 summarise(admitted = sum(admitted)) %>% 
 ggplot(aes(x = region,
            y = admitted, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Number of admitted by region") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

##### Admitted with zero mention

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_without, region) %>% 
 group_by(region) %>% 
 summarise(zero = sum(admitted_without)) %>% 
 ggplot(aes(x = region, 
            y = zero, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with zero mention") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

##### Admitted with mention AB

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_AB, region) %>% 
 group_by(region) %>% 
 summarise(AB = sum(admitted_AB)) %>% 
 ggplot(aes(x = region, 
            y = AB, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention AB") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

##### Admitted with mention B

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_B, region) %>% 
 group_by(region) %>% 
 summarise(B = sum(admitted_B)) %>% 
 ggplot(aes(x = region, 
            y = B, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention B") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

##### Admitted with mention TB

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_results %>% 
 select(admitted_TB, region) %>% 
 group_by(region) %>% 
 summarise(TB = sum(admitted_TB)) %>% 
 ggplot(aes(x = region, 
            y = TB, 
            fill = region)) + 
        geom_col() +
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention TB") +
        ylab("Number of students")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("x" ,"y"))

```

####{-}

#### Period 2006-2021 by region {.tabset}

**One description for all of what we see and highlight differences (e.g. Bretagne in B and zero, zero and AB decreasing and B and TB increasing)**

##### Success rate

```{r, echo=TRUE}
y_scale_pct <- scale_y_continuous(limits = range(c(0:100)))

```

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(success_rate_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(success_rate = mean(success_rate_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = success_rate, 
            color = region,
            text = region)) + 
        geom_line() +
        y_scale_pct +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Success rate") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with zero mention

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(without_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(zero = mean(without_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = zero, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with zero mention") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention AB

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(AB_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(AB = mean(AB_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = AB, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention AB") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention B

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(B_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(B = mean(B_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = B, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention B") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

##### Admitted with mention TB

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

 p <- dnb_results %>% 
 select(TB_pct, region, session) %>% 
 group_by(region, session) %>% 
 summarise(TB = mean(TB_pct, na.rm = TRUE)) %>% 
 ggplot(aes(x = session, 
            y = TB, 
            color = region,
            text = region)) + 
        geom_line() +
        scale_color_viridis(discrete = TRUE) +
        theme_ipsum() +
        ggtitle("Admitted with mention TB") +
        ylab("Rate in %")+
        theme(axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.ticks.x=element_blank())

ggplotly(p, tooltip = c("text","x" ,"y" ))

```

####{-}

### Departmental Analysis

#### Box plot Analysis per department {.tabset}

```{r, echo=TRUE}

dnb_pct_dep <- dnb_results %>%
  group_by(department, session) %>% 
  summarise(AB_pct_dep = mean(AB_pct, na.rm = TRUE),
            B_pct_dep = mean(B_pct, na.rm = TRUE),
            TB_pct_dep = mean(TB_pct, na.rm = TRUE),
            without_pct_dep = mean(without_pct, na.rm = TRUE),
            success_rate_pct_dep = mean(success_rate_pct, na.rm = TRUE))
datatable(dnb_pct_dep)
```

**Small descritption for each and one analysis encompassing them all. (e.g mention that confidence interval is small or big, and increasing or decreasing)**

##### success_rate_pct

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = success_rate_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = success_rate_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", y = "Success rate in %",
                title ="Success rate of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### without_pct

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = without_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = without_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with no mention in %",
              title ="Rate of students with no mention of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
        
```

##### B_pct

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = B_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = B_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Bien in %",
              title ="Rate of students with mention Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### AB_pct

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = AB_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = AB_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Assez Bien in %",
              title ="Rate of students with mention Assez Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))
```

##### TB_pct

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- dnb_pct_dep %>% 
  ggplot(aes(x = session, 
             y = TB_pct_dep, 
             group = session, 
             fill = session, 
             text = department,
             text2 = TB_pct_dep)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+ 
        scale_fill_gradientn(colors = viridis(16))+
        guides(fill = "none")+
        labs( x= "", 
              y = "Rate of students with mention Très Bien in %",
              title ="Rate of students with mention Très Bien of each Department by session")

ggplotly(p, tooltip = c("text","text2"))

```

####  {.unnumbered}

#### Box plot Analysis of at the Department level {.tabset}

**Analyse first differences between 2020 and 2006 and then talk about differences between paris and eure et loir**

##### Paris 2020

First analysis of the best performing highest rate of TB -\> Paris 2020

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

Paris <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  filter(department == "PARIS", session == "2020") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Paris$Mention_type <- factor(Paris$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

p <- Paris %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Parisian establishments in 2020")

ggplotly(p, tooltip = c("text","text2"))


```

##### Paris 2006

First analysis of the best performing highest rate of TB -> Paris 2020

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

Paris <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  filter(department == "PARIS", session == "2006") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Paris$Mention_type <- factor(Paris$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

p <- Paris %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Parisian establishments in 2006")

ggplotly(p, tooltip = c("text","text2"))


```

##### Eure et Loir 2020 {.unnumbered}

Lowest performing department in TB rate and "best" in zero mention rate -> Guyane 2006

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

Eure <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  dplyr::filter(department == "EURE-ET-LOIR", session == "2020") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Eure$Mention_type <- factor(Eure$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

 p <- Eure %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Eure et Loir establishments in 2020")

ggplotly(p, tooltip = c("text","text2"))
```

##### Eure et Loir 2006 {.unnumbered}

Lowest performing department in TB rate and "best" in zero mention rate -\> Guyane 2006

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

Eure <- dnb_results %>%
  select(school_id,establishment_name,department,session, contains("pct")) %>% 
  dplyr::filter(department == "EURE-ET-LOIR", session == "2006") %>% 
  pivot_longer(c(contains("pct")), # pivot longer to allow for a clean and easy boxplot graph with each pct
               names_to = "Mention_type",
               values_to = "Rate")
Eure$Mention_type <- factor(Eure$Mention_type, levels = c("success_rate_pct","without_pct", "AB_pct", "B_pct", "TB_pct")) #creation of factor to order the graph

 p <- Eure %>% 
 ggplot(aes(x = Mention_type, 
             y = Rate, 
             fill = Mention_type, 
             text = establishment_name,
             text2 = Rate)) +
        geom_boxplot()+
        geom_jitter(width = 0.25, alpha = 0.5)+
        guides(fill = "none")+
        scale_fill_viridis(discrete = TRUE) +
        theme_ipsum() +
        labs( x= "", 
              y = "Rate in %",
              title ="Results for Eure et Loir establishments in 2006")

ggplotly(p, tooltip = c("text","text2"))
```

####  {.unnumbered}

## Establishment_24

```{r, echo = TRUE}

map_theme <- theme(title=element_text(),
                   plot.title=element_text(margin=margin(20,20,20,20), size=18, hjust = 0.5),
                   axis.text.x=element_blank(),
                   axis.text.y=element_blank(),
                   axis.ticks=element_blank(),
                   axis.title.x=element_blank(),
                   axis.title.y=element_blank(),
                   panel.grid.major= element_blank(), 
                   panel.background= element_blank()) 

p <- ggplot() +
  geom_polygon(data = map, aes(long,lat, group = group), fill = "white", color = "grey") +
  geom_point(data = establishment_24, aes(x = longitude , y = latitude, text2= establishment), size = 0.5)+
  coord_map() +
  scale_fill_viridis(name = "Average sucess rate")+
  labs(x = "", 
       y = "", 
       title = "Average success rate, 2006-2021") +
  map_theme

ggplotly(p, tooltip = c("text2") )
```




####  New establishment 2024 labellization per department and year {.tabset}

```{r, echo=TRUE}
establishment_24_dep_map <- left_join(x = map[,-6], y = establishment_24_dep, by = "department_fr")
```

##### 2017

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2017) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2017")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2018

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2018) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2018")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2019

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2019) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2019")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2020

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2020) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2020")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2021

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2021) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2021")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2022

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-establishment_24_dep_map  %>% 
  filter(session_started == 2022) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= establishment), color = "black") +
  scale_fill_viridis(name = "Number of establishment") +
  labs(x = "", 
       y = "", 
       title = " New establishment 2024 labellization in 2022")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```


#### {.unnumbered}

## student_housing
```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}
p <- student_housing %>% 
  select(session, external_students_secondary_education, half_boarders_students_secondary_education, boarding_students_secondary_education) %>% 
  group_by(session) %>% 
  summarise(external_students_secondary_education = sum(external_students_secondary_education, na.rm = TRUE),
            half_boarders_students_secondary_education = sum(half_boarders_students_secondary_education, na.rm = TRUE), 
            boarding_students_secondary_education = sum(boarding_students_secondary_education, na.rm = TRUE)) %>% 
  gather("Housing_option", "students", 2:4) %>%  
  ggplot(aes(x=session, 
              y=students,
              fill=Housing_option)) +
    geom_bar(stat="identity", position=position_dodge())+
    ggtitle("Students per housing option in France")+
    xlab("year")+
    ylab("Students")+
    scale_fill_viridis(discrete = TRUE)+
    theme_ipsum()

ggplotly(p, tooltip = "y")
```

####  Housing option rate in secondary education per department {.tabset}

##### external students
```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- housing_dep %>% 
  ggplot(aes(x = as.factor(session), 
             y = external_students_rate, 
             group = session, 
             fill = session, 
             text = department_fr,
             text2 = external_students_rate)) +
  geom_boxplot()+
  geom_jitter(width = 0.25, alpha = 0.5)+ 
  scale_fill_viridis()+
  guides(fill = "none")+
  labs( x= "",
        y = "Rate of external students in %",
        title ="Rate of external students of each Department by session")+
  theme_ipsum()

ggplotly(p, tooltip = c("text","text2"))

```


##### half-boarders students
```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- housing_dep %>% 
  ggplot(aes(x = as.factor(session), 
             y = half_boarders_students_rate, 
             group = session, 
             fill = session, 
             text = department_fr,
             text2 = half_boarders_students_rate)) +
  geom_boxplot()+
  geom_jitter(width = 0.25, alpha = 0.5)+ 
  scale_fill_viridis()+
  guides(fill = "none")+
  labs( x= "",
        y = "Rate of half-boarders students in %",
        title ="Rate of half-boarders  students of each Department by session")+
  theme_ipsum()

ggplotly(p, tooltip = c("text","text2"))

```


##### boarding students
```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- housing_dep %>% 
  ggplot(aes(x = as.factor(session), 
             y = boarding_students_rate, 
             group = session, 
             fill = session, 
             text = department_fr,
             text2 = boarding_students_rate)) +
  geom_boxplot()+
  geom_jitter(width = 0.25, alpha = 0.5)+ 
  scale_fill_viridis()+
  guides(fill = "none")+
  labs( x= "",
        y = "Rate of boarding students in %",
        title ="Rate of boarding students of each Department by session")+
  theme_ipsum()

ggplotly(p, tooltip = c("text","text2"))

```
#### {.unnumbered}

## single_parent
The first visualisation we wanted to do was a barplot that would show the evolution of the total number of single-parent families in France from 2007 to 2008. To do this, we had to isolate, in a dataset called sp_, the sing_par and session variables, then summarized the number of single-parents with “sum”. In order to remove the years that did not interest us, we had to use the filter function. We then were able to use geom_bar.

```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}
sp1_ <- single_parent %>%
  select(c("session", "sing_par")) %>%
  group_by(session)%>%
  summarise (sing_par = sum(sing_par, na.rm = TRUE))

sp1_$session <- as.factor(sp1_$session)

barplot_pos <- ggplot(data = sp1_, aes(x = as.factor(session), 
                                       y = sing_par, 
                                       fill = session))+
  geom_col(stat = "identity" )+
  scale_x_discrete(labels=as.character(sp1_$session), breaks= sp1_$session)+
  scale_fill_viridis(discrete = TRUE) +
  theme_ipsum()

barplot_pos
```
Based on the barplot, we can make an overall analysis of the evolution of single-parent families in France over the years. Although we are missing several years, we can clearly see that the number of single-parent families has continued to increase since 2007. In fact, single-parent families numbered 2,427,110 in 2007, whereas in 2018, they were numbering 3,031,823. In just over 10 years, there has been a 20% increase.

#### Single-parent families by departments, 2007
We need to create a data set needed to create the maps.We join the single_parent and map data sets using `department_fr`.  
```{r, echo=TRUE, warning=FALSE}
jmap_sp<- left_join(x = map[,-6], y = single_parent, by = "department_fr")
```


```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}
p <-jmap_sp %>% 
  filter(session == 2007) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families in 2007")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))

```


```{r, echo=TRUE}
sing_dnb <- left_join(x = single_parent, y = dnb_results_dep, by = c("department_fr", "session"))
```

```{r, echo=TRUE}
sing_dnb <- sing_dnb %>% 
  mutate(single_parent_per_student_admitted = sing_par/admitted)
#Join with the map data set for the mapping. 
sing_dnb_map <- left_join(x = map[,-6], y = sing_dnb, by = "department_fr")
```

####  Single parent families per student admitted {.tabset}
##### 2007

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2007) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2007")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2008

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2008) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2008")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2012

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2012) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2012")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

##### 2013

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2013) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2013")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```


##### 2017

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2017) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2017")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```


##### 2018

```{r, echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}


p <-sing_dnb_map %>% 
  filter(session == 2018) %>%
  ggplot(aes(x = long, 
             y = lat, 
             group = group, 
             text = department_fr)) +
  geom_polygon(aes(fill= single_parent_per_student_admitted), color = "black") +
  scale_fill_viridis(name = "Number of single parent families") +
  labs(x = "", 
       y = "", 
       title = "Single parent families per student admitted in 2018")+
  map_theme

ggplotly(p, tooltip = c("text","fill"))
```

#### {.unnumbered}

##  covid_in_schools

First, we wanted to get an overview of COVID positive cases in France over the years. So we used ggplot with test_date as the x-axis and positive for the y-axis.
```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}
p <- covid_in_schools %>% 
  select(positive, test_date) %>% 
  group_by(test_date) %>% 
  summarise(positive = sum(positive)) %>% 
  ggplot( mapping = aes(x= test_date, y = positive)) +
  geom_line() +
  labs(title = "French Covid-19 cases from the age group 11 to 15 years old (2020-2022)", x = "Date", y = "Number of cases")+
  theme_ipsum()

ggplotly(p, tooltip = c("x","y"))
```


```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}
p <- covid_in_schools %>%
  select(c("department_code", "positive", "session", "region", "department_fr", "test_date")) %>%
  group_by(region, test_date) %>%
  summarise(positive = sum(positive)) %>% 
  ggplot() +
  geom_line(mapping = aes(x = test_date, y = positive, color = region))+
   scale_color_viridis(discrete = TRUE) +
    ggtitle("Covid-19 cases from the age group 11 to 15 years old by region (2020-2022)") +
    theme_ipsum()

ggplotly(p, tooltip = c("x","y", "color"))


```

####  Incidence rate average per session {.tabset}

```{r, echo=TRUE}
covidpos_dep <- covid_in_schools %>% 
  select(c("department_code", "incidence_rate", "session", "department_fr" )) %>% 
  group_by(department_fr, session) %>%
  summarise(incidence_rate = mean(incidence_rate, na.rm = TRUE))

covidpos_dep <- left_join(x = map[,-6], y = covidpos_dep)

```

##### 2020
```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- covidpos_dep %>% 
  filter(session == 2020) %>% 
  ggplot( aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= incidence_rate), color = "black") +
  coord_map()+
  scale_fill_viridis(name = "Incidence rate average in 2020")+
  map_theme

ggplotly(p)
```
##### 2021
```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- covidpos_dep %>% 
  filter(session == 2021) %>% 
  ggplot( aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= incidence_rate), color = "black") +
  coord_map()+
  scale_fill_viridis(name = "Incidence rate average in 2021")+
  map_theme

ggplotly(p)
```
##### 2022
```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- covidpos_dep %>% 
  filter(session == 2022) %>% 
  ggplot( aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= incidence_rate), color = "black") +
  coord_map()+
  scale_fill_viridis(name = "Incidence rate average in 2022")+
  map_theme

ggplotly(p)
```
##### 2023
```{r , echo=TRUE, warning=FALSE, out.width='100%', out.height= '50%'}

p <- covidpos_dep %>% 
  filter(session == 2023) %>% 
  ggplot( aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= incidence_rate), color = "black") +
  coord_map()+
  scale_fill_viridis(name = "Incidence rate average in 2023")+
  map_theme

ggplotly(p)
```


#### {.unnumbered}


-   Mapping out the underlying structure
-   Identifying the most important variables
-   Univariate visualizations
-   Multivariate visualizations
-   Summary tables
