#Wrangling

##Single-parent families (wrangling)

1. The single_parent dataset is in excel format, so we have to use read_excel. Then, we use skip because the document includes extra header information rows. We reuse the rename_df function that we created before to name the columns.
```{r , echo=TRUE}
single_parent <- read_excel(here::here("data/insee_rp_hist_xxxx.xlsx", skip = 4))
sg_parent_names <- c("geocode", "department", "session","sing_par")
single_parent <- rename_df(insee_rp_hist_xxxx_4_dep, sg_parent_names)
```
2. We have to change the scalar of the "session" and "single_par" variables into doubles.
```{r , echo=TRUE}
single_parent[["session"]]<- as.double(single_parent[["session"]])
single_parent[["sing_par"]]<- as.double(single_parent[["sing_par"]])
```
3. Finally, We need to change the format of the department column in order to facilitate the join with the dnb dataset in the analysis part.
```{r , echo=TRUE}
single_parent$department <- str_to_upper(single_parent$department)%>%
  gsub("É","E", .) %>%
  gsub("È","E", .) %>%
  gsub("Ô","O", .) %>%
  gsub ("Â", "A", .)
```


##Covid in schools (wrangling)

1. Translate the colum names
```{r , echo=TRUE}
covide_names <- c("department_code", "test_week", "educational_level", "age_group", "pop", "positive", "tested", "incidence_rate", "positivity_rate", "screening_rate")
covid_in_schools <- rename_df(Covid_sp_dep_7j_cage_scol_2022_10_10_19h02,covide_names)
```
2. test_week will be treated in (3.). Therefore, positive, incidence_rate and positivity_rate need to be doubles
```{r , echo=TRUE}
covid_in_schools[["positive"]] <- as.double(gsub(",",".", covid_in_schools[["positive"]]))
covid_in_schools[["incidence_rate"]] <- as.double(gsub(",",".", covid_in_schools[["incidence_rate"]]))
covid_in_schools[["positivity_rate"]] <- as.double(gsub(",",".", covid_in_schools[["positivity_rate"]]))
```
3.We need to create two new variables: the first will be the date categorizing each week called test_date. We choose the first date (Monday). Also, a session column is necessary to constitute the academic school years. Dates with months between January and July will be considered the previous year (for example, January 11, 2021 is part of the 2020 session). The number of Covid cases in August is relatively low compared to the rest of the year and represents at maximum 6 days of tests. Therefore we consider this margin of error to be satisfactory.
```{r , echo=TRUE}
covid_in_schools <- covid_in_schools %>%
  mutate(test_date = case_when( as.numeric(substr(test_week, 1,4))== 2020
                                ~ lubridate::ymd('2019-12-30') + lubridate::weeks(as.numeric(substr(test_week, 7,8))),
                                as.numeric(substr(test_week, 1,4))== 2021
                                ~ lubridate::ymd('2021-01-04') + lubridate::weeks(as.numeric(substr(test_week, 7,8))),
                                as.numeric(substr(test_week, 1,4))== 2022
                                ~ lubridate::ymd('2022-01-03') + lubridate::weeks(as.numeric(substr(test_week, 7,8)))
  ))
                               
covid_in_schools <- covid_in_schools %>%
  mutate(session = case_when(month(test_date) <= 7 ~ year(test_date)-1,
                             month(test_date) >  7 ~ year(test_date)))
```
4. We are only interested in the age group of 11 to 15
```{r , echo=TRUE}
covid_in_schools <- covid_in_schools %>%
  filter(educational_level == "[11-15)")
```



#Exploratory analysis

##Single-parent families

First, our idea was to join the dnb dataset to the single parent dataset by the “department” variable. However, the name of the department differed between the dnb dataset and the single parent dataset, So we had to create a “department_fr” variable in both datasets that were in the same format, as well as the format of ggplot (useful for mapping). We then did a left join called singpar_dnb called singpar_dnb  and grouped by “department_fr” and “session”, because we only needed the years 2007, 2008, 2012, 2013, 2017, and 2018.
```{r , echo=TRUE}
single_parent$department_fr <- stri_trans_general(single_parent$department, "Latin-ASCII") %>%
  str_to_title(.) %>%
  gsub("Du", "du", .) %>%
  gsub("De", "de", .) %>%
  gsub("D'", "D", .) %>%
  gsub("Et", "et", .) %>%
  gsub(" ", "-", .) %>%
  str_replace_all("Corse-du-Sud", "Corse du Sud") %>%
  str_replace_all("deux-Sevres", "Deux-Sevres") %>%
  str_replace_all("Alpes-de-Hte-Provence", "Alpes-de-Haute-Provence") %>%      
  str_replace_all("Territoire-de-Belfort", "Territoire de Belfort") %>%
  str_replace_all("Seine-Saint-denis", "Seine-Saint-Denis")

dnb_results$department_fr <- stri_trans_general(dnb_results$department, "Latin-ASCII") %>%
  str_to_title(.) %>%
  gsub("Du", "du", .) %>%
  gsub("De", "de", .) %>%
  gsub("D'", "D", .) %>%
  gsub("Et", "et", .) %>%
  gsub(" ", "-", .) %>%
  str_replace_all("Corse-du-Sud", "Corse du Sud") %>%
  str_replace_all("deux-Sevres", "Deux-Sevres") %>%
  str_replace_all("Alpes-de-Hte-Provence", "Alpes-de-Haute-Provence") %>%      
  str_replace_all("Territoire-de-Belfort", "Territoire de Belfort") %>%
  str_replace_all("Seine-Saint-denis", "Seine-Saint-Denis")
 
singpar_dnb <- left_join(x = dnb_results, y = single_parent, by =c("session","department_fr"))
singpar_dnb
```

The first visualisation we wanted to do was a barplot that would show the evolution of the total number of single-parent families in France from 2007 to 2008. To do this, we had to isolate, in a dataset called sp_, the sing_par and session variables, then summarized the number of single-parents with “sum”. In order to remove the years that did not interest us, we had to use the filter function. We then were able to use geom_bar.
```{r , echo=TRUE}
sp_ <- singpar_dnb %>%
  select(c("session", "sing_par")) %>%
  group_by(session)%>%
  summarise (sing_par = sum(sing_par, na.rm = TRUE))%>%
  filter(!row_number()%in% c(1,4,5,6,9,10,11,14,15,16))

barplot_pos <- ggplot(data = sp_, aes(x=session, y= sing_par))+
  geom_bar(stat = "identity", fill="steelblue")+
  scale_x_continuous(labels=as.character(sp1_$session), breaks= sp1_$session)+
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))+
  geom_text(aes(label=sing_par), vjust = 1.6, color = "white", size = 2)+
  theme_minimal()
barplot_pos
```
Based on the barplot, we can make an overall analysis of the evolution of single-parent families in France over the years. Although we are missing several years, we can clearly see that the number of single-parent families has continued to increase since 2007. In fact, single-parent families numbered 2,427,110 in 2007, whereas in 2018, they were numbering 3,031,823. In just over 10 years, there has been a 20% increase.

Our second visualisation is a mapping of single-parent families by departments. We will use the sinpar_dnb dataset to join the map dataset of France (accessible via map_data). The region variable in the map dataset was actually the departments, so a quick renaming was needed. We then created datasets for each year, grouped by departement_fr, and joined “map” with the latters. Finally, we used ggplotly to do the mapping.
```{r , echo=TRUE}
map <- map_data("france")
colnames(map)[5]<- "department_fr"
map_theme <- theme(title=element_text(),
                   plot.title=element_text(margin=margin(20,20,20,20), size=18, hjust = 0.5),
                   axis.text.x=element_blank(),
                   axis.text.y=element_blank(),
                   axis.ticks=element_blank(),
                   axis.title.x=element_blank(),
                   axis.title.y=element_blank(),
                   panel.grid.major= element_blank(),
                   panel.background= element_blank())


sp_07<- singpar_dnb %>%
  group_by(department_fr) %>%
  filter(session == 2007)
sp_08<- singpar_dnb %>%
  group_by(department_fr) %>%
  filter(session == 2008)
sp_12<- singpar_dnb %>%
  group_by(department_fr) %>%
  filter(session == 2012)
sp_13<- singpar_dnb %>%
  group_by(department_fr)%>%
  filter(session == 2013)
sp_17<- singpar_dnb %>%
  group_by(department_fr) %>%
  filter(session == 2017)
sp_18<- singpar_dnb %>%
  group_by(department_fr)%>%
  filter(session == 2018)

map_sp_07 <- sp_07 %>%
  select(department_fr, sing_par)
map_sp_08 <- sp_08 %>%
  select(department_fr, sing_par)
map_sp_12 <- sp_12 %>%
  select(department_fr, sing_par)
map_sp_13 <- sp_13 %>%
  select(department_fr, sing_par)
map_sp_17 <- sp_17 %>%
  select(department_fr, sing_par)
map_sp_18 <- sp_18 %>%
  select(department_fr, sing_par)

jmap_sp_07<- left_join(x = map[,-6], y = map_sp_07)
jmap_sp_08<- left_join(x = map[,-6], y = map_sp_08)
jmap_sp_12<- left_join(x = map[,-6], y = map_sp_12)
jmap_sp_13<- left_join(x = map[,-6], y = map_sp_13)
jmap_sp_17<- left_join(x = map[,-6], y = map_sp_17)
jmap_sp_18<- left_join(x = map[,-6], y = map_sp_18)

map1_sp_07 <- ggplot(jmap_sp_07, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2007") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_07 <- ggplotly(map1_sp_07, tooltip = c("text","fill"))
fr_sp_07

map1_sp_08 <- ggplot(jmap_sp_08, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2008") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_08 <- ggplotly(map1_sp_08, tooltip = c("text","fill"))
fr_sp_08

map1_sp_12 <- ggplot(jmap_sp_12, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2012") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_12 <- ggplotly(map1_sp_12, tooltip = c("text","fill"))
fr_sp_12

map1_sp_13 <- ggplot(jmap_sp_13, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2013") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_13 <- ggplotly(map1_sp_13, tooltip = c("text","fill"))
fr_sp_13

map1_sp_17 <- ggplot(jmap_sp_17, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2017") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_17 <- ggplotly(map1_sp_17, tooltip = c("text","fill"))
fr_sp_17

map1_sp_18 <- ggplot(jmap_sp_18, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= sing_par), color = "black") +
  scale_fill_viridis(name = "single parent families in 2018") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_sp_18 <- ggplotly(map1_sp_18, tooltip = c("text","fill"))
fr_sp_18
```
By comparing the maps, we see that even if the proportions always remain the same over the years, the number of single-parent families always increases for each of the departments. We can conclude that the number of single parents has increased uniformly throughout France. There has not been one department that has experienced sudden growth compared to the others.

However, we can note that the rate of single parenthood is higher in Ile-de-France, in the North and in the departments bordering the Mediterranean. The two departments that stand out are Nord and Bouches-du-Rhône, with rates above 93,000. It will therefore be important to keep an eye on these two departments when analyzing the results of Diploma Brevet National (DNB).

##Covid in schools

First, we wanted to get an overview of COVID positive cases in France over the years. So we used ggplot with test_date as the x-axis and positive for the y-axis.
```{r , echo=TRUE}
positive_over_tested <- ggplot(data = covid_in_schools , mapping = aes(x= test_date, y = positive)) +
  geom_line() +
  labs(title = "Positive cases", x = "date", y = "number of people")
positive_over_tested
```
From the 2020 until 2022, we can notice waves of covid cases for the age group 11 to 15,. Indeed, every 6 months, the number of positive cases increases to nearly 1000 positive cases per day and then drops to around 500 positive cases per day. However, we can observe a clear increase, with a peak of more than 10,000 positive cases per day, in January 2022 . The 2021-2022 academic year is therefore a year to keep an eye on, when comparing with the results of DNB. After this increase, the number of positive cases fell significantly to remain around 500-1000 positive cases per day.

For the second exploratory analysis, we wanted to compare the positive cases by regions. First, we created reg_department in order to select the interesting columns from dnb_resluts (“department_code”, "department_fr" and”region"). Then, we had to join covid_in_school to reg_department by department_code. However, to match the department codes of the reg_department dataset, it was necessary to use the paste0 function to add a 0 to each value of the covid dataset. We then were able to create covidpos_reg, which showed the evolution of positive cases through time by region, and used it to generate the graph of positive covid cases in each region over the years.
```{r , echo=TRUE}
dnb_results$department_fr <- stri_trans_general(dnb_results$department, "Latin-ASCII") %>%
  str_to_title(.) %>%
  gsub("Du", "du", .) %>%
  gsub("De", "de", .) %>%
  gsub("D'", "D", .) %>%
  gsub("Et", "et", .) %>%
  gsub(" ", "-", .) %>%
  str_replace_all("Corse-du-Sud", "Corse du Sud") %>%
  str_replace_all("deux-Sevres", "Deux-Sevres") %>%
  str_replace_all("Alpes-de-Hte-Provence", "Alpes-de-Haute-Provence") %>%      
  str_replace_all("Territoire-de-Belfort", "Territoire de Belfort") %>%
  str_replace_all("Seine-Saint-denis", "Seine-Saint-Denis")
covid_in_schools[["department_code"]] <- paste0("0", covid_in_schools[["department_code"]])

reg_department <- dnb_results %>%
  select(c("department_code", "department_fr", "region")) %>%
  unique()
covid_reg <- inner_join(x = covid_in_schools, y = reg_department, by = "department_code")
covidpos_reg<- covid_reg %>%
  select(c("department_code", "positive", "session", "region", "department_fr", "test_date")) %>%
  group_by(region, test_date) %>%
  summarise(positive = sum(positive, na.rm = TRUE))
 
graph_pos_by_reg <- ggplot(data = covidpos_reg) +
  geom_line(mapping = aes(x = test_date, y = positive, color = region))
graph_pos_by_reg
```
For the age group 11 to 15, Ile-de-France and Auvergne-Rhone-Alpes seem to be the two regions with the most positive covid cases through time. Corse, in contrary, appears to the be the region with the fewest positive cases.


The last vizualization for the covid dataset is a mapping of positive covid cases by departments. We created datasets for each session(2019, 2020, 2021, 2022), grouped by department_fr and joined them with “map”. We used ggplotly to do the mapping.
```{r , echo=TRUE}
covidpos_dep <- select(covid_reg, c("department_code", "positive", "session", "department_fr" ))

pos_2019 <- covidpos_dep %>%
  filter(session == 2019)%>%
  group_by(department_code, department_fr, session)%>%
  summarise(positive = sum(positive))
pos_2020 <- covidpos_dep %>%
  filter(session == 2020)%>%
  group_by(department_code, department_fr, session)%>%
  summarise(positive = sum(positive))
pos_2021 <- covidpos_dep %>%
  filter(session == 2021)%>%
  group_by(department_code, department_fr, session)%>%
  summarise(positive = sum(positive))
pos_2022 <- covidpos_dep %>%
  filter(session == 2022)%>%
  group_by(department_code, department_fr, session)%>%
  summarise(positive = sum(positive))

map <- map_data("france")
colnames(map)[5]<- "department_fr"
jpos_2019 <- left_join(x = map[,-6], y = pos_2019)
jpos_2020 <- left_join(x = map[,-6], y = pos_2020)
jpos_2021 <- left_join(x = map[,-6], y = pos_2021)
jpos_2022 <- left_join(x = map[,-6], y = pos_2022)

map_pos_2019 <- ggplot(jpos_2019, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= positive), color = "black") +
  scale_fill_viridis(name = "total positive covid cases in 2019") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_pos_2019 <- ggplotly(map_pos_2019, tooltip = c("text","fill"))
fr_pos_2019

map_pos_2020 <- ggplot(jpos_2020, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= positive), color = "black") +
  scale_fill_viridis(name = "total positive covid cases in 2020") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_pos_2020 <- ggplotly(map_pos_2020, tooltip = c("text","fill"))
fr_pos_2020

map_pos_2021 <- ggplot(jpos_2021, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= positive), color = "black") +
  scale_fill_viridis(name = "total positive covid cases in 2021") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_pos_2021 <- ggplotly(map_pos_2021, tooltip = c("text","fill"))
fr_pos_2021

map_pos_2022 <- ggplot(jpos_2022, aes(x= long, y= lat, group=group, text = department_fr)) +
  geom_polygon(aes(fill= positive), color = "black") +
  scale_fill_viridis(name = "total positive covid cases in 2022") +
  theme(axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        rect = element_blank())
fr_pos_2022 <- ggplotly(map_pos_2022, tooltip = c("text","fill"))
fr_pos_2022
```
During the 2019 academic year, the number of positive cases in children aged 11 to 15 remains relatively low in each of the departments. The maximum is 89 cases in the Nord department. The Ile de France region (where Paris is located) also has a high number (around 30 positive cases) compared to other departments.
In 2020, the scale indicates a clear increase in the proportions of covid-positive cases in each of the departments, ranging from 4K to 69K cases per department. The departments of Nord and Ile de France remain the most affected. However, the Rhône and Bouche-du-Rhône experienced the strongest rises (up to 11K and 10K positive cases respectively).
During the start of the 2021 school year, while the number of positive cases in the departments most affected in the previous years (Nord, Ile de France, Rhône and Bouche-du-Rhône) increased less gradually or even stabilised,  other departments such as Gironde, Loire L'Atlantique and Pas-de-Calais are on the rise (up to around 40K).
Finally, in 2022, there is an overall decrease by department. Indeed, the maximum is 4K positive cases. The most affected departments are still Nord, Rhône, Bouche-du-Rhône, Isère, Pas-de-Calais and Gironde.
Overall, we can conclude that from 2019 to 2021, the most affected regions were Nord, the departments of Ile de France, and those around the Rhône river. The departments least affected by covid are rather those located in the center of France.
